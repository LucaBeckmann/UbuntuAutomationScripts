#!/bin/bash

LOGFILE="/var/log/user_setup_upgrade.log"

log() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') : $message" | tee -a "$LOGFILE"
}

if [ "$(id -u)" -ne 0 ]; then
    log "ERROR: This script must be run as root."
    exit 1
fi

set -e

log "===================================================="
log "==== UPGRADE SCRIPT FOR USER SETUP (v2)        ===="
log "===================================================="

# Step 1: Update timezone interactively
while true; do
    read -rp "Enter desired timezone (e.g., Europe/Berlin): " TIMEZONE
    if timedatectl list-timezones | grep -qx "$TIMEZONE"; then
        timedatectl set-timezone "$TIMEZONE"
        log "Timezone updated to $TIMEZONE."
        break
    else
        echo "Invalid timezone. Please try again."
    fi
done

# Step 2: Set custom hostname
read -rp "Enter a hostname for this server: " CUSTOM_HOSTNAME
log "Setting hostname to: $CUSTOM_HOSTNAME"
hostnamectl set-hostname "$CUSTOM_HOSTNAME"
echo "$CUSTOM_HOSTNAME" > /etc/motd_hostname.conf
chmod 644 /etc/motd_hostname.conf
log "Hostname saved to /etc/motd_hostname.conf"

# Step 3: Create MOTD script
MOTD_SCRIPT="/etc/profile.d/login_motd.sh"

cat <<'EOF' > "$MOTD_SCRIPT"
#!/bin/bash

if [ -f /etc/motd_hostname.conf ]; then
    SERVER_NAME=$(cat /etc/motd_hostname.conf)
else
    SERVER_NAME=$(hostname)
fi

SERVER_IP=$(hostname -I | awk '{print $1}')

if [[ -n "$SSH_CONNECTION" ]]; then
    CLIENT_IP=$(echo $SSH_CONNECTION | awk '{print $1}')
else
    CLIENT_IP="local/unknown"
fi

echo
echo "=============================================="
echo "🖥️  Welcome to $SERVER_NAME ($SERVER_IP)"
echo "🔑 Logged in from: $CLIENT_IP"
echo "----------------------------------------------"

if command -v apt &>/dev/null; then
    UPDATES=$(apt list --upgradeable 2>/dev/null | grep -v "Listing..." | wc -l)
    if [ "$UPDATES" -gt 0 ]; then
        echo "📦 $UPDATES package(s) can be updated."
    else
        echo "✅ System is up to date."
    fi
fi

echo "=============================================="
echo
EOF

chmod +x "$MOTD_SCRIPT"
log "MOTD script installed at $MOTD_SCRIPT"

log "===================================================="
log "==== Upgrade completed successfully.            ===="
log "===================================================="
